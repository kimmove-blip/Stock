# V6 백테스트 분석 및 V7 개선안

## 📊 V6 백테스트 결과 핵심 분석

### 1. 결과 요약
```
총 거래: 530회
승률: 29.2%
총 손익: -1,423,124원 (-0.91%)
```

### 2. 청산유형별 성과 (핵심 문제점)

| 청산유형 | 비율 | 승률 | 평균수익률 | 총손익 |
|----------|------|------|------------|--------|
| **TARGET_HIT** | 17.0% | 98.9% | **+9.09%** | +2,414,680원 |
| **STOP_HIT** | 54.2% | 0% | **-4.50%** | -3,811,212원 |
| TIME_EXIT | 28.9% | 43.1% | -0.06% | -26,592원 |

### 3. 핵심 문제 진단

```
┌─────────────────────────────────────────────────────────────┐
│  손익비 설계 vs 실제                                         │
├─────────────────────────────────────────────────────────────┤
│  설계 손익비: 2:1 (ATR×2 : ATR×1)                           │
│  실제 손익비: 2.02:1 (9.09% : 4.50%) ✅ 설계대로 작동        │
├─────────────────────────────────────────────────────────────┤
│  손익분기 TARGET 비율: 33.1% 필요                            │
│  실제 TARGET 비율: 23.9% (TIME_EXIT 제외)                    │
│  → 9.2%p 부족! ❌                                           │
└─────────────────────────────────────────────────────────────┘
```

**문제: 손익비는 잘 작동하지만, TARGET_HIT 도달률이 너무 낮음**

### 4. 경고 신호 분석 (숨겨진 원인)

| 경고 신호 | 거래수 | 평균수익률 |
|-----------|--------|------------|
| LOW_LIQUIDITY | 356회 | -1.29% |
| RESISTANCE_NEARBY | 267회 | -0.79% |
| CONSECUTIVE_DOWN_DAYS | 184회 | -1.10% |

**발견: 경고 신호가 있는 종목들의 성과가 더 나쁨!**

### 5. 신호별 성과 분석

| 신호 | 거래수 | 평균수익률 | 판정 |
|------|--------|------------|------|
| SELLING_EXHAUSTED | 2 | +1.19% | ✅ 유망 (샘플 부족) |
| VCP_PATTERN | 400 | -0.73% | ⚠️ 과대평가 |
| BB_EXTREME_SQUEEZE | 334 | -0.68% | ⚠️ 과대평가 |
| VOL_CONTRACTION | 68 | -1.81% | ❌ 역효과 |
| ATR_SHRINKING | 213 | -1.24% | ❌ 역효과 |

---

## 🔧 V7 개선 방향

### 방향 1: 경고 신호를 "과락 조건"으로 격상

**현재 V6**: 경고만 표시, 투자 진행
```python
# V6: 경고만 표시
if warning:
    result['warnings'].append(warning)
    # 투자는 계속...
```

**V7 제안**: 특정 경고는 과락 처리
```python
# V7: 경고 → 과락
DISQUALIFY_WARNINGS = [
    'RESISTANCE_NEARBY',      # 상방에 매물대 → 목표가 도달 어려움
    'CONSECUTIVE_DOWN_DAYS',  # 연속 하락 → 추세 역행
]

if any(w in warnings for w in DISQUALIFY_WARNINGS):
    result['score'] = 0  # 과락
```

### 방향 2: 유동성 필터 강화

**현재**: 거래대금 10억 미만만 경고
**V7**: 거래대금 30억 미만은 제외

```python
# V7: 유동성 필터
MIN_TRADING_VALUE = 3_000_000_000  # 30억
if trading_value < MIN_TRADING_VALUE:
    return None  # 분석 자체 제외
```

### 방향 3: 손익비 조정 (가장 중요!)

**문제**: TARGET_HIT 23.9% < 손익분기점 33.1%

**해결책 A: 목표가 낮추기**
```
현재: ATR × 2.0 = 평균 +9.09%
변경: ATR × 1.5 = 예상 +6.8%
→ 손익분기: 30% → 도달 가능성 높아짐
```

**해결책 B: 손절폭 좁히기**
```
현재: ATR × 1.0 = 평균 -4.50%
변경: ATR × 0.7 = 예상 -3.15%
→ 손익비 2.8:1 → 손익분기 26.3%
```

**해결책 C: 추세 필터 추가 (추천)**
```python
# 상승추세 종목만 진입
if close > ma20 > ma60:  # 정배열
    pass  # 진입 허용
else:
    return None  # 제외
```

### 방향 4: 시간 손절 단축

**현재**: 5일 후 종가 청산 → 43% 승률, -0.06%
**문제**: 방향성 없이 표류 → 기회비용

**V7 제안**:
```python
# 3일 후 청산 또는 트레일링 스탑
MAX_HOLD_DAYS = 3
# 또는
if day >= 2 and current_price < entry_price:
    exit()  # 2일 이상 손실 시 조기 청산
```

### 방향 5: 모멘텀 전환 신호 가중치 상향

**분석**: 모멘텀 전환(15점)이 실제 상승 예측에 더 중요

```python
# V7: 모멘텀 비중 확대
# V6: 에너지(35) + 매집(30) + 지지(20) + 모멘텀(15) = 100
# V7: 에너지(25) + 매집(25) + 지지(20) + 모멘텀(30) = 100
```

---

## 📋 V7 설계안

### 점수 체계 (100점)

```
┌─────────────────────────────────────────────────────────────┐
│  V7 점수 체계 (모멘텀 중심)                                   │
├─────────────────────────────────────────────────────────────┤
│  1. 추세 확인 (25점) - 상승추세 여부                          │
│  ├─ 정배열 (Close > MA20 > MA60)         +15               │
│  ├─ 20일선 위                            +5                │
│  └─ 60일선 위                            +5                │
│                                                             │
│  2. 모멘텀 전환 (30점) - 방향 전환 신호                       │
│  ├─ MACD 골든크로스                      +10               │
│  ├─ RSI 과매도 탈출 (30→위)              +8                │
│  ├─ 스토캐스틱 바닥 골든크로스            +7                │
│  └─ 거래량 급증 양봉                     +5                │
│                                                             │
│  3. 에너지 축적 (25점) - 폭발 대기                           │
│  ├─ 볼린저 수축 (극심)                   +10               │
│  ├─ ATR 수축                            +8                │
│  └─ VCP 패턴                            +7                │
│                                                             │
│  4. 수급/지지 (20점) - 안전망                                │
│  ├─ OBV 상승                            +8                │
│  ├─ 이평선 지지                          +7                │
│  └─ 피보나치 지지                        +5                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 과락 조건 (강화)

```python
DISQUALIFY_CONDITIONS = [
    # V6 유지
    'STRONG_REVERSE_ALIGNMENT',   # 강한 역배열
    'RSI_EXTREME_OVERBOUGHT',     # RSI 85+
    'POSSIBLE_CLIMAX_TOP',        # 천장 신호
    'SHARP_DECLINE',              # 당일 -5%
    
    # V7 추가
    'RESISTANCE_NEARBY',          # 상방 매물대 (NEW)
    'CONSECUTIVE_DOWN_DAYS_4',    # 4일 연속 음봉 (NEW)
    'LOW_LIQUIDITY_SEVERE',       # 거래대금 10억 미만 (NEW)
    'BELOW_MA60',                 # 60일선 아래 (NEW)
]
```

### 청산 전략 (개선)

```python
# V7 청산 전략
TARGET_MULT = 1.5       # 목표: ATR × 1.5 (낮춤)
STOP_MULT = 0.8         # 손절: ATR × 0.8 (좁힘)
MAX_HOLD_DAYS = 3       # 최대: 3일 (단축)

# 트레일링 스탑 추가
if current_profit >= ATR * 0.5:
    stop_price = max(stop_price, entry_price)  # 본전 스탑

# 조기 청산 조건
if hold_days >= 2 and current_price < entry_price:
    exit('EARLY_EXIT')  # 2일째 손실 시 청산
```

### 예상 효과

```
V6 실제:
  TARGET_HIT: 17.0% (+9.09%)
  STOP_HIT: 54.2% (-4.50%)
  → 순손익: 17% × 9.09 - 54.2% × 4.50 = -0.89%

V7 예상 (낙관적):
  TARGET_HIT: 30% (+6.8%)   # 목표 낮춤 → 도달 증가
  STOP_HIT: 45% (-3.15%)    # 손절 좁힘 + 필터 강화
  → 순손익: 30% × 6.8 - 45% × 3.15 = +0.62%

V7 예상 (보수적):
  TARGET_HIT: 25% (+6.8%)
  STOP_HIT: 50% (-3.15%)
  → 순손익: 25% × 6.8 - 50% × 3.15 = +0.12%
```

---

## 🎯 즉시 테스트 가능한 개선안

### 최소 변경 (V6.1)

```python
# 1. 경고 → 과락 격상
if 'RESISTANCE_NEARBY' in warnings:
    return None  # 투자 제외

if 'CONSECUTIVE_DOWN_DAYS' in warnings:
    return None  # 투자 제외

# 2. 유동성 필터
if trading_value < 2_000_000_000:  # 20억 미만
    return None

# 3. 추세 필터
if close < ma60:  # 60일선 아래
    return None
```

### 백테스트 명령어

```bash
# V6.1 테스트 (필터만 추가)
python backtest_swing_v6.py --min-score 50 --weeks 52

# V7 테스트 (손익비 변경)
python backtest_swing_v6.py --target-mult 1.5 --stop-mult 0.8 --max-hold 3
```

---

## 📌 결론

### V6 실패 원인
1. **TARGET_HIT 도달률 부족** (23.9% vs 필요 33.1%)
2. **경고 신호 무시** (RESISTANCE_NEARBY 등)
3. **추세 역행 진입** (하락 중 매수)

### V7 핵심 변경
1. **목표가 낮춤** (ATR×2 → ×1.5)
2. **경고 → 과락** (RESISTANCE, DOWN_DAYS)
3. **추세 필터** (60일선 위만 진입)
4. **시간 손절 단축** (5일 → 3일)

### 기대 효과
- 거래 빈도: ↓ (엄격한 필터)
- TARGET_HIT 비율: ↑ (목표 낮춤 + 필터)
- 손익분기 도달: 가능성 ↑
