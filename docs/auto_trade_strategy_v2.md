# 자동매매 전략 문서 v2.0

> 최종 업데이트: 2026-02-04
> 작성자: Claude Code AI Assistant

---

## 버전 히스토리

| 버전 | 날짜 | 주요 변경사항 |
|------|------|---------------|
| v2.0 | 2026-02-04 | 시간대별 전략 분리, 골든타임 도입, 시간대별 손절선 |
| v1.0 | 2026-02-03 | 기본 V2/V4 기반 전략, V5 홀딩 조건 |

---

## 1. 현황 분석 (v1.0 → v2.0 개선 전)

### 1.1 문제점

| 지표 | v1.0 실적 | 목표 |
|------|-----------|------|
| 총 손익 | **-262,056원** | 양수 전환 |
| 승률 | 35.5% (92/259) | 50%+ |
| 평균 손익 | -1,012원/거래 | +500원+ |

### 1.2 시간대별 성과 분석 (핵심 발견)

| 시간대 | 거래수 | 승률 | 총손익 | 분석 |
|--------|--------|------|--------|------|
| **09시** | 45 | **42.2%** | **+790,000원** | 최고 성과 |
| 10시 | 52 | 34.6% | -180,000원 | 변동성 큼 |
| **11-12시** | 시뮬 | **59.3%** | **+0.88%** | 최적 구간 |
| 13-14시 | 78 | 33.3% | -320,000원 | 피해야 함 |
| **23시(야간)** | 12 | **0%** | **-597,000원** | 즉시 제거 |

**핵심 인사이트:**
- 11-12시 골든타임이 가장 높은 승률 (59.3%)
- 오후 13-14시는 성과가 좋지 않음
- 야간 거래는 0% 승률로 치명적 손실

---

## 2. v2.0 전략 개요

### 2.1 시간대별 전략 분리

```
┌─────────────────────────────────────────────────────────────────────┐
│  09:10~09:25  │  09:30~10:55  │  11:00~12:55  │  13:00~14:50  │ 14:55~ │
│  Early Surge  │     오전      │   골든타임    │     오후      │ 정리   │
│   (엄격)      │   (보수적)    │   (완화)      │   (강화)      │ 매도   │
│  V2>=85       │   V2>=80      │   V2>=70      │   V2>=85      │ 매수   │
│  V4>=60       │   V4>=55      │   V4>=45      │   V4>=60      │ 금지   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 매수 조건 상세

#### Early Surge (09:10~09:25)
```python
조건:
  - MACD_BULL 시그널 필수
  - MA_ALIGNED 또는 MA_STEEP 필수
  - 등락률 0% ~ 8%
  - V2 >= 85
  - V4 >= 60
```

#### 오전 (09:30~10:55)
```python
조건:
  - V2 >= 80
  - V4 >= 55
```

#### 골든타임 (11:00~12:55) ⭐ 핵심 개선
```python
조건 (완화):
  - V2 >= 70  (↓ 10점 완화)
  - V4 >= 45  (↓ 10점 완화)
  - V4_DELTA <= 0 (급등중 제외)

보너스:
  - V1 <= 40 이면 역발상 가점 (분석 결과 V1 낮을수록 성과 좋음)
```

#### 오후 (13:00~14:50)
```python
조건 (강화):
  - V2 >= 85
  - V4 >= 60
  - V4_DELTA <= 0 (급등중 제외)
```

#### 정리매도 시간 (14:55~)
```python
- 신규 매수 금지
- V5 >= 70 종목만 홀딩 유지
- V5 < 70 종목 정리매도
```

---

## 3. 홀딩/매도 전략

### 3.1 V5 기반 홀딩 조건

| 조건 | 동작 | 비고 |
|------|------|------|
| V5 >= 70 | **강력 홀딩** | 익일까지 보유 (54.9% 승률, +0.70%) |
| V5 >= 60 AND V4 >= 50 | 홀딩 | 추가 상승 가능성 |
| V4 >= 55 | 홀딩 | 수급 양호 |
| V2 >= 60 | 홀딩 | 추세 유지 |
| V4 < 40 | **매도** | 수급 악화 |
| V2 < 50 AND V4 < 45 | **매도** | 복합 약세 |

### 3.2 시간대별 손절선

| 시간대 | 손절 기준 | 이유 |
|--------|----------|------|
| 오전 (09~10시) | **-5%** | 빠른 손절로 손실 최소화 |
| 골든타임 (11~12시) | **-7%** | 충분한 반등 기회 부여 |
| 오후 (13시 이후) | **-4%** | 더 빠른 손절 (성과 안좋은 시간) |

---

## 4. 야간 거래 차단

### 4.1 문제
- 23시 거래 12건 중 **승률 0%**, **-597,000원 손실**

### 4.2 해결
```python
# auto_trader.py run_intraday()
if now.hour >= 16 or now.hour < 9:
    return {"status": "skipped", "reason": "night_trading_blocked"}
```

---

## 5. 관련 파일

| 파일 | 설명 |
|------|------|
| `config.py` | StrategyConfig 클래스 - 시간대/임계값 상수 |
| `trading/buy_sell_logic.py` | should_buy_advanced(), check_hold_condition() |
| `auto_trader.py` | run_intraday(), _filter_buy_candidates() |

---

## 6. 예상 효과

| 지표 | v1.0 | v2.0 예상 |
|------|------|-----------|
| 승률 | 35.5% | **50%+** |
| 총 손익 | -262,056원 | **+100,000원+** |
| 평균 손익/거래 | -1,012원 | **+400원+** |

### 주요 개선 포인트
1. **골든타임 집중**: 11-12시 완화 조건으로 거래 기회 확대
2. **야간 거래 제거**: -597,000원 손실 방지
3. **V5 홀딩 강화**: 상승 추세 종목 익일 홀딩
4. **시간대별 손절**: 시간대 특성에 맞는 리스크 관리

---

## 7. 향후 개선 방향

### 7.1 데이터 기반 최적화
- [ ] 골든타임 임계값 미세 조정 (V2: 68~72, V4: 43~47)
- [ ] 오후 전략 시간대 세분화 (13시 vs 14시)
- [ ] 요일별 성과 분석 및 전략 차별화

### 7.2 추가 시그널 활용
- [ ] 체결강도 조건 추가 (매수세 우위 확인)
- [ ] 외국인/기관 수급 반영
- [ ] 섹터별 모멘텀 분석

### 7.3 리스크 관리 강화
- [ ] 당일 최대 손실 제한 (Daily Loss Limit)
- [ ] 연속 손실 시 매매 중단
- [ ] 포트폴리오 분산 최적화

---

## 8. 테스트 방법

### 8.1 Dry-run 테스트
```bash
cd /home/kimhc/Stock && source venv/bin/activate
python auto_trader.py --dry-run --all
```

### 8.2 백테스트 (과거 데이터)
```bash
python backtest_intraday_signals.py --strategy v2
```

### 8.3 실시간 모니터링
```bash
# 서버 로그 확인
tail -f /tmp/stock_api.log

# 거래 내역 확인
sqlite3 database/auto_trade.db "SELECT * FROM trade_history ORDER BY id DESC LIMIT 10;"
```

---

## 9. 설정 값 참조 (config.py)

```python
class StrategyConfig:
    # 시간대 정의
    EARLY_SURGE_START = (9, 10)
    EARLY_SURGE_END = (9, 25)
    MORNING_END_HOUR = 11
    GOLDEN_HOUR_START = 11
    GOLDEN_HOUR_END = 13
    AFTERNOON_END = (14, 50)
    CLOSING_START = (14, 55)

    # 매수 임계값 (시간대별)
    EARLY_V2_MIN = 85
    EARLY_V4_MIN = 60
    MORNING_V2_MIN = 80
    MORNING_V4_MIN = 55
    GOLDEN_V2_MIN = 70
    GOLDEN_V4_MIN = 45
    AFTERNOON_V2_MIN = 85
    AFTERNOON_V4_MIN = 60

    # 홀딩 조건
    HOLD_V5_STRONG = 70
    HOLD_V5_MIN = 60
    HOLD_V4_MIN = 55
    HOLD_V2_MIN = 60

    # 손절 (시간대별)
    STOP_LOSS_MORNING = 5.0
    STOP_LOSS_GOLDEN = 7.0
    STOP_LOSS_AFTERNOON = 4.0
```

---

*이 문서는 자동매매 전략의 버전 관리 및 지속적인 개선을 위해 작성되었습니다.*
